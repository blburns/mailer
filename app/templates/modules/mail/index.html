{% extends 'base.html' %}
{% block title %}Mail Server{% endblock %}
{% block content %}
  <div class="max-w-screen-xl mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
      <div>
        <h1 class="text-3xl font-extrabold text-gray-900 dark:text-white">
          Mail Server Management
        </h1>
        <p class="text-gray-600 dark:text-gray-400 mt-2">
          Manage Postfix MTA and Dovecot IMAP/POP3 services
        </p>
      </div>
      <div class="flex space-x-3">
        <button onclick="refreshAllStatus()" class="inline-flex items-center px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium rounded-lg transition-colors duration-200">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          Refresh Status
        </button>
      </div>
    </div>

    <!-- Service Status Overview -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
      <!-- Postfix MTA Status -->
      <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Postfix MTA</h3>
          <span id="postfix-status-badge" class="px-3 py-1 text-sm font-medium rounded-full bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200">
            Loading...
          </span>
        </div>
        <p class="text-gray-600 dark:text-gray-400 mb-4">Mail Transfer Agent</p>
        
        <div class="space-y-3 mb-4">
          <div class="flex justify-between items-center">
            <span class="text-gray-600 dark:text-gray-400">Service Status:</span>
            <span id="postfix-service-status" class="text-sm font-medium">-</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-600 dark:text-gray-400">Queue Size:</span>
            <span id="postfix-queue-size" class="text-sm font-medium">-</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-600 dark:text-gray-400">Last Updated:</span>
            <span id="postfix-last-updated" class="text-sm text-gray-500">-</span>
          </div>
        </div>
        
        <div class="flex space-x-2">
          <button onclick="restartPostfix()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-lg transition-colors duration-200 inline-flex items-center">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Restart
          </button>
          <button onclick="reloadPostfix()" class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white text-sm font-medium rounded-lg transition-colors duration-200 inline-flex items-center">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18"></path>
            </svg>
            Reload
          </button>
          <button onclick="checkPostfixConfig()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors duration-200 inline-flex items-center">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Check Config
          </button>
        </div>
      </div>
      
      <!-- Dovecot IMAP Status -->
      <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Dovecot IMAP</h3>
          <span id="dovecot-status-badge" class="px-3 py-1 text-sm font-medium rounded-full bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200">
            Loading...
          </span>
        </div>
        <p class="text-gray-600 dark:text-gray-400 mb-4">IMAP/POP3 Server</p>
        
        <div class="space-y-3 mb-4">
          <div class="flex justify-between items-center">
            <span class="text-gray-600 dark:text-gray-400">Service Status:</span>
            <span id="dovecot-service-status" class="text-sm font-medium">-</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-600 dark:text-gray-400">Active Connections:</span>
            <span id="dovecot-connections" class="text-sm font-medium">-</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-600 dark:text-gray-400">Last Updated:</span>
            <span id="dovecot-last-updated" class="text-sm text-gray-500">-</span>
          </div>
        </div>
        
        <div class="flex space-x-2">
          <button onclick="restartDovecot()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-lg transition-colors duration-200 inline-flex items-center">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Restart
          </button>
          <button onclick="reloadDovecot()" class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white text-sm font-medium rounded-lg transition-colors duration-200 inline-flex items-center">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18"></path>
            </svg>
            Reload
          </button>
          <button onclick="checkDovecotConfig()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors duration-200 inline-flex items-center">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Check Config
          </button>
        </div>
      </div>
    </div>

    <!-- Mail Queue Management -->
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 mb-8">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Mail Queue Management</h3>
        <button onclick="refreshQueueInfo()" class="inline-flex items-center px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium rounded-lg transition-colors duration-200">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          Refresh
        </button>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div class="text-center p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
          <div class="text-2xl font-bold text-gray-900 dark:text-white" id="queue-count">-</div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Messages in Queue</div>
        </div>
        <div class="text-center p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
          <div class="text-2xl font-bold text-gray-900 dark:text-white" id="queue-size">-</div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Queue Size (KB)</div>
        </div>
        <div class="text-center p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
          <div class="text-2xl font-bold text-gray-900 dark:text-white" id="queue-age">-</div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Oldest Message (hrs)</div>
        </div>
      </div>
      
      <div class="flex space-x-3">
        <button onclick="flushQueue()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-lg transition-colors duration-200">
          Flush Queue
        </button>
        <button onclick="showQueueDetails()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium rounded-lg transition-colors duration-200">
          View Details
        </button>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700">
        <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">Domain Management</h4>
        <p class="text-gray-600 dark:text-gray-400 mb-4">Add or remove domains from Postfix</p>
        <button onclick="showDomainManager()" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors duration-200">
          Manage Domains
        </button>
      </div>
      
      <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700">
        <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">Configuration</h4>
        <p class="text-gray-600 dark:text-gray-400 mb-4">View and edit service configurations</p>
        <button onclick="showConfigManager()" class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors duration-200">
          View Config
        </button>
      </div>
      
      <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700">
        <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">Logs & Monitoring</h4>
        <p class="text-gray-600 dark:text-gray-400 mb-4">Access service logs and monitoring</p>
        <button onclick="showLogs()" class="w-full px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg transition-colors duration-200">
          View Logs
        </button>
      </div>
    </div>

    <!-- Service Monitoring Dashboard -->
    <div class="mt-8 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Service Monitoring</h3>
        <div class="flex space-x-3">
          <button onclick="startMonitoring()" id="startMonitorBtn" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors duration-200">
            Start Monitoring
          </button>
          <button onclick="stopMonitoring()" id="stopMonitorBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-lg transition-colors duration-200 hidden">
            Stop Monitoring
          </button>
        </div>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
        <div class="text-center p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
          <div class="text-2xl font-bold text-gray-900 dark:text-white" id="totalEmails">-</div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Total Emails Today</div>
        </div>
        <div class="text-center p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
          <div class="text-2xl font-bold text-gray-900 dark:text-white" id="deliveredEmails">-</div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Delivered</div>
        </div>
        <div class="text-center p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
          <div class="text-2xl font-bold text-gray-900 dark:text-white" id="failedEmails">-</div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Failed</div>
        </div>
        <div class="text-center p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
          <div class="text-2xl font-bold text-gray-900 dark:text-white" id="avgDeliveryTime">-</div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Avg Delivery (ms)</div>
        </div>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-3">Recent Activity</h4>
          <div id="recentActivity" class="space-y-2 max-h-48 overflow-y-auto">
            <div class="text-center text-gray-500 dark:text-gray-400 py-4">No recent activity</div>
          </div>
        </div>
        <div>
          <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-3">Performance Metrics</h4>
          <div class="space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-gray-600 dark:text-gray-400">CPU Usage:</span>
              <div class="flex items-center space-x-2">
                <div class="w-24 bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                  <div id="cpuBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <span id="cpuPercent" class="text-sm font-medium text-gray-900 dark:text-white">0%</span>
              </div>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-600 dark:text-gray-400">Memory Usage:</span>
              <div class="flex items-center space-x-2">
                <div class="w-24 bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                  <div id="memoryBar" class="bg-green-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <span id="memoryPercent" class="text-sm font-medium text-gray-900 dark:text-white">0%</span>
              </div>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-600 dark:text-gray-400">Disk Usage:</span>
              <div class="flex items-center space-x-2">
                <div class="w-24 bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                  <div id="diskBar" class="bg-yellow-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <span id="diskPercent" class="text-sm font-medium text-gray-900 dark:text-white">0%</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Queue Details Modal -->
  <div id="queueModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full max-h-[80vh] overflow-hidden">
        <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
          <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Mail Queue Details</h3>
          <button onclick="closeQueueModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div class="p-6 overflow-y-auto max-h-[60vh]">
          <pre id="queue-details" class="text-sm text-gray-800 dark:text-gray-200 bg-gray-50 dark:bg-gray-700 p-4 rounded-lg overflow-x-auto"></pre>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Initialize status on page load
    document.addEventListener('DOMContentLoaded', function() {
      refreshAllStatus();
    });

    // Refresh all service statuses
    function refreshAllStatus() {
      refreshPostfixStatus();
      refreshDovecotStatus();
      refreshQueueInfo();
    }

    // Postfix status management
    function refreshPostfixStatus() {
      fetch('/mail/postfix/status')
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.success) {
            updatePostfixStatus(data.status);
          } else {
            updatePostfixStatus({ status: 'error', message: data.message });
          }
        })
        .catch(error => {
          console.error('Postfix status error:', error);
          updatePostfixStatus({ status: 'error', message: error.message });
        });
    }

    function updatePostfixStatus(status) {
      const badge = document.getElementById('postfix-status-badge');
      const serviceStatus = document.getElementById('postfix-service-status');
      const queueSize = document.getElementById('postfix-queue-size');
      const lastUpdated = document.getElementById('postfix-last-updated');
      
      if (status.status === 'running') {
        badge.className = 'px-3 py-1 text-sm font-medium rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
        badge.textContent = 'Running';
        serviceStatus.textContent = 'Active';
        queueSize.textContent = status.queue_count || 0;
      } else if (status.status === 'stopped') {
        badge.className = 'px-3 py-1 text-sm font-medium rounded-full bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
        badge.textContent = 'Stopped';
        serviceStatus.textContent = 'Inactive';
        queueSize.textContent = '-';
      } else {
        badge.className = 'px-3 py-1 text-sm font-medium rounded-full bg-yellow-500 text-white-900 dark:bg-yellow-500 dark:text-white-900';
        badge.textContent = 'Error';
        serviceStatus.textContent = 'Error';
        queueSize.textContent = '-';
      }
      
      lastUpdated.textContent = new Date().toLocaleTimeString();
    }

    // Dovecot status management
    function refreshDovecotStatus() {
      fetch('/mail/dovecot/status')
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.success) {
            updateDovecotStatus(data.status);
          } else {
            updateDovecotStatus({ status: 'error', message: data.message });
          }
        })
        .catch(error => {
          console.error('Dovecot status error:', error);
          updateDovecotStatus({ status: 'error', message: error.message });
        });
    }

    function updateDovecotStatus(status) {
      const badge = document.getElementById('dovecot-status-badge');
      const serviceStatus = document.getElementById('dovecot-service-status');
      const connections = document.getElementById('dovecot-connections');
      const lastUpdated = document.getElementById('dovecot-last-updated');
      
      if (status.status === 'running') {
        badge.className = 'px-3 py-1 text-sm font-medium rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
        badge.textContent = 'Running';
        serviceStatus.textContent = 'Active';
        connections.textContent = '0'; // TODO: Get actual connection count
      } else if (status.status === 'stopped') {
        badge.className = 'px-3 py-1 text-sm font-medium rounded-full bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
        badge.textContent = 'Stopped';
        serviceStatus.textContent = 'Inactive';
        connections.textContent = '-';
      } else {
        badge.className = 'px-3 py-1 text-sm font-medium rounded-full bg-yellow-500 text-white-900 dark:bg-yellow-500 dark:text-white-900';
        badge.textContent = 'Error';
        serviceStatus.textContent = 'Error';
        connections.textContent = '-';
      }
      
      lastUpdated.textContent = new Date().toLocaleTimeString();
    }

    // Queue management
    function refreshQueueInfo() {
      fetch('/mail/postfix/queue')
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.success) {
            updateQueueInfo(data.queue);
          } else {
            updateQueueInfo({ count: 0, details: 'Error loading queue info' });
          }
        })
        .catch(error => {
          console.error('Queue info error:', error);
          updateQueueInfo({ count: 0, details: 'Error: ' + error.message });
        });
    }

    function updateQueueInfo(queue) {
      document.getElementById('queue-count').textContent = queue.count || 0;
      document.getElementById('queue-size').textContent = '-'; // TODO: Calculate actual size
      document.getElementById('queue-age').textContent = '-'; // TODO: Calculate actual age
    }

    // Service control functions
    function restartPostfix() {
      if (confirm('Are you sure you want to restart Postfix? This will temporarily stop mail processing.')) {
        addActivityEntry('Postfix restart initiated', 'warning');
        
        fetch('/mail/postfix/restart', { method: 'POST' })
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
          })
          .then(data => {
            if (data.success) {
              alert('Postfix restarted successfully');
              addActivityEntry('Postfix restarted successfully', 'success');
              setTimeout(refreshPostfixStatus, 2000);
            } else {
              alert('Failed to restart Postfix: ' + data.message);
              addActivityEntry('Postfix restart failed: ' + data.message, 'error');
            }
          })
          .catch(error => {
            console.error('Postfix restart error:', error);
            alert('Error: ' + error.message);
            addActivityEntry('Postfix restart error: ' + error.message, 'error');
          });
      }
    }

    function reloadPostfix() {
      if (confirm('Reload Postfix configuration? This will apply configuration changes without stopping the service.')) {
        addActivityEntry('Postfix configuration reload initiated', 'info');
        
        fetch('/mail/postfix/reload', { method: 'POST' })
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
          })
          .then(data => {
            if (data.success) {
              alert('Postfix configuration reloaded successfully');
              addActivityEntry('Postfix configuration reloaded successfully', 'success');
              setTimeout(refreshPostfixStatus, 1000);
            } else {
              alert('Failed to reload Postfix: ' + data.message);
              addActivityEntry('Postfix configuration reload failed: ' + data.message, 'error');
            }
          })
          .catch(error => {
            console.error('Postfix reload error:', error);
            alert('Error: ' + error.message);
            addActivityEntry('Postfix configuration reload error: ' + error.message, 'error');
          });
      }
    }

    function checkPostfixConfig() {
      fetch('/mail/postfix/check-config', { method: 'POST' })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.success) {
            if (data.result.valid) {
              alert('Postfix configuration is valid!');
            } else {
              alert('Postfix configuration has errors:\n' + data.result.message);
            }
          } else {
            alert('Failed to check configuration: ' + data.message);
          }
        })
        .catch(error => {
          console.error('Postfix config check error:', error);
          alert('Error: ' + error.message);
        });
    }

    function restartDovecot() {
      if (confirm('Are you sure you want to restart Dovecot? This will disconnect all IMAP/POP3 users.')) {
        fetch('/mail/dovecot/restart', { method: 'POST' })
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
          })
          .then(data => {
            if (data.success) {
              alert('Dovecot restarted successfully');
              setTimeout(refreshDovecotStatus, 2000);
            } else {
              alert('Failed to restart Dovecot: ' + data.message);
            }
          })
          .catch(error => {
            console.error('Dovecot restart error:', error);
            alert('Error: ' + error.message);
          });
      }
    }

    function reloadDovecot() {
      if (confirm('Reload Dovecot configuration? This will apply configuration changes without disconnecting users.')) {
        fetch('/mail/dovecot/reload', { method: 'POST' })
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
          })
          .then(data => {
            if (data.success) {
              alert('Dovecot configuration reloaded successfully');
              setTimeout(refreshDovecotStatus, 1000);
            } else {
              alert('Failed to reload Dovecot: ' + data.message);
            }
          })
          .catch(error => {
            console.error('Dovecot reload error:', error);
            alert('Error: ' + error.message);
          });
      }
    }

    function checkDovecotConfig() {
      fetch('/mail/dovecot/check-config', { method: 'POST' })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.success) {
            if (data.result.valid) {
              alert('Dovecot configuration is valid!');
            } else {
              alert('Dovecot configuration has errors:\n' + data.result.message);
            }
          } else {
            alert('Failed to check configuration: ' + data.message);
          }
        })
        .catch(error => {
          console.error('Dovecot config check error:', error);
          alert('Error: ' + error.message);
        });
      }

    function flushQueue() {
      if (confirm('Are you sure you want to flush the mail queue? This will attempt to deliver all queued messages.')) {
        fetch('/mail/postfix/flush-queue', { method: 'POST' })
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
          })
          .then(data => {
            if (data.success) {
              alert('Mail queue flushed successfully');
              setTimeout(refreshQueueInfo, 2000);
            } else {
              alert('Failed to flush queue: ' + data.message);
            }
          })
          .catch(error => {
            console.error('Queue flush error:', error);
            alert('Error: ' + error.message);
          });
      }
    }

    function showQueueDetails() {
      fetch('/mail/postfix/queue')
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.success) {
            const queueDetails = data.queue.details || 'No queue details available';
            document.getElementById('queue-details').textContent = queueDetails;
            document.getElementById('queueModal').classList.remove('hidden');
            
            // Add activity entry
            addActivityEntry('Queue details viewed', 'info');
          } else {
            alert('Failed to load queue details: ' + data.message);
          }
        })
        .catch(error => {
          console.error('Queue details error:', error);
          alert('Error: ' + error.message);
        });
    }

    function closeQueueModal() {
      document.getElementById('queueModal').classList.add('hidden');
    }

    // Domain management
    function showDomainManager() {
      // Create and show domain management modal
      const modal = document.createElement('div');
      modal.id = 'domainModal';
      modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 z-50';
      modal.innerHTML = `
        <div class="flex items-center justify-center min-h-screen p-4">
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full">
            <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
              <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Domain Management</h3>
              <button onclick="closeDomainModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            <div class="p-6">
              <div class="mb-6">
                <div class="flex space-x-3 mb-4">
                  <input type="text" id="newDomain" placeholder="Enter domain name (e.g., example.com)" 
                         class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                  <button onclick="addDomain()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors duration-200">
                    Add Domain
                  </button>
                </div>
              </div>
              <div id="domainsList" class="space-y-2">
                <div class="text-center text-gray-500 dark:text-gray-400 py-4">Loading domains...</div>
              </div>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      loadDomainsList();
    }

    function closeDomainModal() {
      const modal = document.getElementById('domainModal');
      if (modal) {
        modal.remove();
      }
    }

    function loadDomainsList() {
      fetch('/mail/postfix/domains')
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.success) {
            displayDomains(data.domains);
          } else {
            displayDomains([]);
          }
        })
        .catch(error => {
          console.error('Error loading domains:', error);
          displayDomains([]);
        });
    }

    function displayDomains(domains) {
      const domainsList = document.getElementById('domainsList');
      if (domains.length === 0) {
        domainsList.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-4">No domains configured</div>';
        return;
      }

      domainsList.innerHTML = domains.map(domain => `
        <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
          <span class="text-gray-900 dark:text-white font-medium">${domain}</span>
          <button onclick="removeDomain('${domain}')" class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm rounded-lg transition-colors duration-200">
            Remove
          </button>
        </div>
      `).join('');
    }

    function addDomain() {
      const domainInput = document.getElementById('newDomain');
      const domain = domainInput.value.trim();
      
      if (!domain) {
        alert('Please enter a domain name');
        return;
      }

      fetch('/mail/postfix/add-domain', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ domain: domain })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          alert('Domain added successfully');
          domainInput.value = '';
          loadDomainsList();
        } else {
          alert('Failed to add domain: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Add domain error:', error);
        alert('Error: ' + error.message);
      });
    }

    function removeDomain(domain) {
      if (confirm(`Are you sure you want to remove the domain "${domain}"?`)) {
        fetch('/mail/postfix/remove-domain', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ domain: domain })
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.success) {
            alert('Domain removed successfully');
            loadDomainsList();
          } else {
            alert('Failed to remove domain: ' + data.message);
          }
        })
        .catch(error => {
          console.error('Remove domain error:', error);
          alert('Error: ' + error.message);
        });
      }
    }

    // Configuration management
    function showConfigManager() {
      const modal = document.createElement('div');
      modal.id = 'configModal';
      modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 z-50';
      modal.innerHTML = `
        <div class="flex items-center justify-center min-h-screen p-4">
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full max-h-[80vh] overflow-hidden">
            <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
              <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Configuration Files</h3>
              <button onclick="closeConfigModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            <div class="p-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-3">
                  <h4 class="text-lg font-medium text-gray-900 dark:text-white">Postfix Configuration</h4>
                  <button onclick="viewConfigFile('main.cf')" class="w-full text-left px-4 py-3 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg transition-colors duration-200">
                    <div class="font-medium">main.cf</div>
                    <div class="text-sm text-gray-500 dark:text-gray-400">Main Postfix configuration</div>
                  </button>
                  <button onclick="viewConfigFile('master.cf')" class="w-full text-left px-4 py-3 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg transition-colors duration-200">
                    <div class="font-medium">master.cf</div>
                    <div class="text-sm text-gray-500 dark:text-gray-400">Master daemon configuration</div>
                  </button>
                  <button onclick="viewConfigFile('virtual_domains')" class="w-full text-left px-4 py-3 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg transition-colors duration-200">
                    <div class="font-medium">virtual_domains</div>
                    <div class="text-sm text-gray-500 dark:text-gray-400">Virtual domain list</div>
                  </button>
                </div>
                <div class="space-y-3">
                  <h4 class="text-lg font-medium text-gray-900 dark:text-white">Dovecot Configuration</h4>
                  <button onclick="viewConfigFile('dovecot.conf')" class="w-full text-left px-4 py-3 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg transition-colors duration-200">
                    <div class="font-medium">dovecot.conf</div>
                    <div class="text-sm text-gray-500 dark:text-gray-400">Main Dovecot configuration</div>
                  </button>
                  <button onclick="viewConfigFile('10-auth.conf')" class="w-full text-left px-4 py-3 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg transition-colors duration-200">
                    <div class="font-medium">10-auth.conf</div>
                    <div class="text-sm text-gray-500 dark:text-gray-400">Authentication configuration</div>
                  </button>
                  <button onclick="viewConfigFile('10-mail.conf')" class="w-full text-left px-4 py-3 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg transition-colors duration-200">
                    <div class="font-medium">10-mail.conf</div>
                    <div class="text-sm text-gray-500 dark:text-gray-400">Mail configuration</div>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function closeConfigModal() {
      const modal = document.getElementById('configModal');
      if (modal) {
        modal.remove();
      }
    }

    function viewConfigFile(filename) {
      // TODO: Implement actual config file viewing
      alert(`Configuration file viewing for ${filename} will be implemented in the next update`);
    }

    // Log viewing
    function showLogs() {
      const modal = document.createElement('div');
      modal.id = 'logsModal';
      modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 z-50';
      modal.innerHTML = `
        <div class="flex items-center justify-center min-h-screen p-4">
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-6xl w-full max-h-[80vh] overflow-hidden">
            <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
              <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Service Logs</h3>
              <button onclick="closeLogsModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            <div class="p-6">
              <div class="flex space-x-3 mb-4">
                <select id="logService" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                  <option value="postfix">Postfix</option>
                  <option value="dovecot">Dovecot</option>
                  <option value="system">System</option>
                </select>
                <select id="logLevel" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                  <option value="all">All Levels</option>
                  <option value="error">Error Only</option>
                  <option value="warning">Warning & Error</option>
                  <option value="info">Info, Warning & Error</option>
                </select>
                <button onclick="refreshLogs()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition-colors duration-200">
                  Refresh Logs
                </button>
                <button onclick="clearLogs()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-colors duration-200">
                  Clear Logs
                </button>
              </div>
              <div id="logsContent" class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm overflow-auto max-h-96">
                <div class="text-center text-gray-500 py-4">Select a service and click "Refresh Logs" to view logs</div>
              </div>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function closeLogsModal() {
      const modal = document.getElementById('logsModal');
      if (modal) {
        modal.remove();
      }
    }

    function refreshLogs() {
      const service = document.getElementById('logService').value;
      const level = document.getElementById('logLevel').value;
      const logsContent = document.getElementById('logsContent');
      
      logsContent.innerHTML = '<div class="text-center text-gray-500 py-4">Loading logs...</div>';
      
      // TODO: Implement actual log fetching
      setTimeout(() => {
        logsContent.innerHTML = `
          <div class="text-gray-400">[2024-01-15 10:30:15] INFO: ${service} service started successfully</div>
          <div class="text-gray-400">[2024-01-15 10:30:16] INFO: ${service} configuration loaded</div>
          <div class="text-gray-400">[2024-01-15 10:30:17] INFO: ${service} listening on port 25</div>
          <div class="text-green-400">[2024-01-15 10:30:18] SUCCESS: ${service} ready to accept connections</div>
        `;
      }, 1000);
    }

    function clearLogs() {
      if (confirm('Are you sure you want to clear all logs? This action cannot be undone.')) {
        document.getElementById('logsContent').innerHTML = '<div class="text-center text-gray-500 py-4">Logs cleared</div>';
      }
    }

    // Service monitoring functionality
    let monitoringInterval = null;
    let monitoringActive = false;

    function startMonitoring() {
      if (monitoringActive) return;
      
      monitoringActive = true;
      document.getElementById('startMonitorBtn').classList.add('hidden');
      document.getElementById('stopMonitorBtn').classList.remove('hidden');
      
      // Start real-time monitoring
      updateMonitoringStats();
      monitoringInterval = setInterval(updateMonitoringStats, 5000); // Update every 5 seconds
      
      // Add activity entry
      addActivityEntry('Monitoring started', 'info');
    }

    function stopMonitoring() {
      if (!monitoringActive) return;
      
      monitoringActive = false;
      document.getElementById('startMonitorBtn').classList.remove('hidden');
      document.getElementById('stopMonitorBtn').classList.add('hidden');
      
      // Stop monitoring
      if (monitoringInterval) {
        clearInterval(monitoringInterval);
        monitoringInterval = null;
      }
      
      // Add activity entry
      addActivityEntry('Monitoring stopped', 'info');
    }

    function updateMonitoringStats() {
      // Update email statistics (mock data for now)
      updateEmailStats();
      
      // Update performance metrics
      updatePerformanceMetrics();
      
      // Update recent activity
      updateRecentActivity();
    }

    function updateEmailStats() {
      // Mock data - replace with actual API calls
      const totalEmails = Math.floor(Math.random() * 1000) + 100;
      const deliveredEmails = Math.floor(totalEmails * 0.95);
      const failedEmails = totalEmails - deliveredEmails;
      const avgDeliveryTime = Math.floor(Math.random() * 500) + 100;
      
      document.getElementById('totalEmails').textContent = totalEmails.toLocaleString();
      document.getElementById('deliveredEmails').textContent = deliveredEmails.toLocaleString();
      document.getElementById('failedEmails').textContent = failedEmails.toLocaleString();
      document.getElementById('avgDeliveryTime').textContent = avgDeliveryTime;
    }

    function updatePerformanceMetrics() {
      // Mock data - replace with actual system monitoring
      const cpuUsage = Math.floor(Math.random() * 80) + 10;
      const memoryUsage = Math.floor(Math.random() * 60) + 20;
      const diskUsage = Math.floor(Math.random() * 40) + 30;
      
      document.getElementById('cpuBar').style.width = cpuUsage + '%';
      document.getElementById('cpuPercent').textContent = cpuUsage + '%';
      
      document.getElementById('memoryBar').style.width = memoryUsage + '%';
      document.getElementById('memoryPercent').textContent = memoryUsage + '%';
      
      document.getElementById('diskBar').style.width = diskUsage + '%';
      document.getElementById('diskPercent').textContent = diskUsage + '%';
    }

    function updateRecentActivity() {
      const activities = [
        { message: 'Email delivered to user@example.com', type: 'success', time: new Date().toLocaleTimeString() },
        { message: 'Configuration reloaded successfully', type: 'info', time: new Date().toLocaleTimeString() },
        { message: 'Queue processed 15 messages', type: 'info', time: new Date().toLocaleTimeString() },
        { message: 'New domain added: test.com', type: 'success', time: new Date().toLocaleTimeString() }
      ];
      
      const recentActivity = document.getElementById('recentActivity');
      recentActivity.innerHTML = activities.map(activity => `
        <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 rounded-lg">
          <div class="flex items-center space-x-2">
            <span class="w-2 h-2 rounded-full ${activity.type === 'success' ? 'bg-green-500' : activity.type === 'error' ? 'bg-red-500' : 'bg-blue-500'}"></span>
            <span class="text-sm text-gray-700 dark:text-gray-300">${activity.message}</span>
          </div>
          <span class="text-xs text-gray-500 dark:text-gray-400">${activity.time}</span>
        </div>
      `).join('');
    }

    function addActivityEntry(message, type) {
      const recentActivity = document.getElementById('recentActivity');
      const activityDiv = document.createElement('div');
      activityDiv.className = 'flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 rounded-lg';
      activityDiv.innerHTML = `
        <div class="flex items-center space-x-2">
          <span class="w-2 h-2 rounded-full ${type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'}"></span>
          <span class="text-sm text-gray-700 dark:text-gray-300">${message}</span>
        </div>
        <span class="text-xs text-gray-500 dark:text-gray-400">${new Date().toLocaleTimeString()}</span>
      `;
      
      recentActivity.insertBefore(activityDiv, recentActivity.firstChild);
      
      // Keep only last 10 entries
      const entries = recentActivity.children;
      if (entries.length > 10) {
        recentActivity.removeChild(entries[entries.length - 1]);
      }
    }
  </script>
{% endblock %}
