{% extends 'base.html' %}
{% block title %}Postfix Management{% endblock %}
{% block content %}
  <div class="max-w-screen-xl mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
      <div>
        <h1 class="text-3xl font-extrabold text-gray-900 dark:text-white">
          Postfix MTA Management
        </h1>
        <p class="text-gray-600 dark:text-gray-400 mt-2">
          Configure and manage the Mail Transfer Agent
        </p>
      </div>
      <div class="flex space-x-3">
        <a href="{{ url_for('mail.index') }}" class="inline-flex items-center px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium rounded-lg transition-colors duration-200">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
          Back to Mail
        </a>
        <button onclick="refreshPostfixStatus()" class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors duration-200">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          Refresh
        </button>
      </div>
    </div>

    <!-- Service Status Card -->
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 mb-8">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Service Status</h3>
        <span id="postfix-status-badge" class="px-3 py-1 text-sm font-medium rounded-full bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200">
          Loading...
        </span>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div class="text-center p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
          <div class="text-2xl font-bold text-gray-900 dark:text-white" id="service-status">-</div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Service Status</div>
        </div>
        <div class="text-center p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
          <div class="text-2xl font-bold text-gray-900 dark:text-white" id="queue-count">-</div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Queue Size</div>
        </div>
        <div class="text-center p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
          <div class="text-2xl font-bold text-gray-900 dark:text-white" id="last-updated">-</div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Last Updated</div>
        </div>
      </div>
      
      <div class="flex flex-wrap gap-3">
        <button onclick="restartPostfix()" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white text-sm font-medium rounded-lg transition-colors duration-200">
          Restart Service
        </button>
        <button onclick="reloadPostfix()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors duration-200">
          Reload Config
        </button>
        <button onclick="checkPostfixConfig()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors duration-200">
          Check Configuration
        </button>
        <button onclick="showPostfixLogs()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium rounded-lg transition-colors duration-200">
          View Logs
        </button>
      </div>
    </div>

    <!-- Mail Queue Management -->
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 mb-8">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Mail Queue Management</h3>
        <button onclick="refreshQueueInfo()" class="inline-flex items-center px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium rounded-lg transition-colors duration-200">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          Refresh Queue
        </button>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="text-center p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
          <div class="text-2xl font-bold text-gray-900 dark:text-white" id="queue-messages">-</div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Messages</div>
        </div>
        <div class="text-center p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
          <div class="text-2xl font-bold text-gray-900 dark:text-white" id="queue-size-kb">-</div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Size (KB)</div>
        </div>
        <div class="text-center p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
          <div class="text-2xl font-bold text-gray-900 dark:text-white" id="queue-oldest">-</div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Oldest (hrs)</div>
        </div>
        <div class="text-center p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
          <div class="text-2xl font-bold text-gray-900 dark:text-white" id="queue-newest">-</div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Newest (hrs)</div>
        </div>
      </div>
      
      <div class="flex flex-wrap gap-3">
        <button onclick="flushQueue()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-lg transition-colors duration-200">
          Flush Queue
        </button>
        <button onclick="showQueueDetails()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium rounded-lg transition-colors duration-200">
          View Details
        </button>
        <button onclick="deleteQueue()" class="px-4 py-2 bg-red-800 hover:bg-red-900 text-white text-sm font-medium rounded-lg transition-colors duration-200">
          Delete All
        </button>
      </div>
    </div>

    <!-- Domain Management -->
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 mb-8">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Virtual Domain Management</h3>
        <button onclick="showAddDomainModal()" class="inline-flex items-center px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors duration-200">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
          </svg>
          Add Domain
        </button>
      </div>
      
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
          <thead class="bg-gray-50 dark:bg-gray-700">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Domain</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Added</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody id="domains-table" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
            <tr>
              <td colspan="4" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">Loading domains...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Configuration Files -->
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700">
      <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Configuration Files</h3>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="space-y-3">
          <h4 class="text-lg font-medium text-gray-900 dark:text-white">Main Configuration</h4>
          <div class="space-y-2">
            <button onclick="viewConfigFile('main.cf')" class="w-full text-left px-4 py-2 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg transition-colors duration-200">
              main.cf - Main configuration
            </button>
            <button onclick="viewConfigFile('master.cf')" class="w-full text-left px-4 py-2 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg transition-colors duration-200">
              master.cf - Master daemon configuration
            </button>
            <button onclick="viewConfigFile('virtual_domains')" class="w-full text-left px-4 py-2 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg transition-colors duration-200">
              virtual_domains - Virtual domain list
            </button>
          </div>
        </div>
        
        <div class="space-y-3">
          <h4 class="text-lg font-medium text-gray-900 dark:text-white">Maps and Tables</h4>
          <div class="space-y-2">
            <button onclick="viewConfigFile('virtual_mailbox_maps')" class="w-full text-left px-4 py-2 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg transition-colors duration-200">
              virtual_mailbox_maps - Mailbox mappings
            </button>
            <button onclick="viewConfigFile('virtual_alias_maps')" class="w-full text-left px-4 py-2 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg transition-colors duration-200">
              virtual_alias_maps - Alias mappings
            </button>
            <button onclick="viewConfigFile('transport')" class="w-full text-left px-4 py-2 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg transition-colors duration-200">
              transport - Transport mappings
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Domain Modal -->
  <div id="addDomainModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full">
        <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
          <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Add Virtual Domain</h3>
          <button onclick="closeAddDomainModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div class="p-6">
          <form id="addDomainForm" class="space-y-4">
            <div>
              <label for="domain" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Domain Name</label>
              <input type="text" id="domain" name="domain" required 
                     class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                     placeholder="example.com">
            </div>
            <div class="flex space-x-3">
              <button type="submit" class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors duration-200">
                Add Domain
              </button>
              <button type="button" onclick="closeAddDomainModal()" class="flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition-colors duration-200">
                Cancel
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Configuration File Modal -->
  <div id="configModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full max-h-[80vh] overflow-hidden">
        <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
          <h3 id="configModalTitle" class="text-xl font-semibold text-gray-900 dark:text-white">Configuration File</h3>
          <button onclick="closeConfigModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div class="p-6 overflow-y-auto max-h-[60vh]">
          <pre id="config-content" class="text-sm text-gray-800 dark:text-gray-200 bg-gray-50 dark:bg-gray-700 p-4 rounded-lg overflow-x-auto"></pre>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      refreshPostfixStatus();
      refreshQueueInfo();
      loadDomains();
    });

    // Postfix status management
    function refreshPostfixStatus() {
      fetch('/mail/postfix/status')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            updatePostfixStatus(data.status);
          } else {
            updatePostfixStatus({ status: 'error', message: data.message });
          }
        })
        .catch(error => {
          updatePostfixStatus({ status: 'error', message: error.message });
        });
    }

    function updatePostfixStatus(status) {
      const badge = document.getElementById('postfix-status-badge');
      const serviceStatus = document.getElementById('service-status');
      const queueCount = document.getElementById('queue-count');
      const lastUpdated = document.getElementById('last-updated');
      
      if (status.status === 'running') {
        badge.className = 'px-3 py-1 text-sm font-medium rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
        badge.textContent = 'Running';
        serviceStatus.textContent = 'Active';
        queueCount.textContent = status.queue_count || 0;
      } else if (status.status === 'stopped') {
        badge.className = 'px-3 py-1 text-sm font-medium rounded-full bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
        badge.textContent = 'Stopped';
        serviceStatus.textContent = 'Inactive';
        queueCount.textContent = '-';
      } else {
        badge.className = 'px-3 py-1 text-sm font-medium rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
        badge.textContent = 'Error';
        serviceStatus.textContent = 'Error';
        queueCount.textContent = '-';
      }
      
      lastUpdated.textContent = new Date().toLocaleTimeString();
    }

    // Queue management
    function refreshQueueInfo() {
      fetch('/mail/postfix/queue')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            updateQueueInfo(data.queue);
          } else {
            updateQueueInfo({ count: 0, details: 'Error loading queue info' });
          }
        })
        .catch(error => {
          updateQueueInfo({ count: 0, details: 'Error: ' + error.message });
        });
    }

    function updateQueueInfo(queue) {
      document.getElementById('queue-messages').textContent = queue.count || 0;
      document.getElementById('queue-size-kb').textContent = '-'; // TODO: Calculate actual size
      document.getElementById('queue-oldest').textContent = '-'; // TODO: Calculate actual age
      document.getElementById('queue-newest').textContent = '-'; // TODO: Calculate actual age
    }

    // Service control functions
    function restartPostfix() {
      if (confirm('Are you sure you want to restart Postfix? This will temporarily stop mail processing.')) {
        fetch('/mail/postfix/restart', { method: 'POST' })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('Postfix restarted successfully');
              setTimeout(refreshPostfixStatus, 2000);
            } else {
              alert('Failed to restart Postfix: ' + data.message);
            }
          })
          .catch(error => alert('Error: ' + error.message));
      }
    }

    function reloadPostfix() {
      if (confirm('Reload Postfix configuration? This will apply configuration changes without stopping the service.')) {
        fetch('/mail/postfix/reload', { method: 'POST' })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('Postfix configuration reloaded successfully');
              setTimeout(refreshPostfixStatus, 1000);
            } else {
              alert('Failed to reload Postfix: ' + data.message);
            }
          })
          .catch(error => alert('Error: ' + error.message));
      }
    }

    function checkPostfixConfig() {
      fetch('/mail/postfix/check-config', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            if (data.result.valid) {
              alert('Postfix configuration is valid!');
            } else {
              alert('Postfix configuration has errors:\n' + data.result.message);
            }
          } else {
            alert('Failed to check configuration: ' + data.message);
          }
        })
        .catch(error => alert('Error: ' + error.message));
    }

    function flushQueue() {
      if (confirm('Are you sure you want to flush the mail queue? This will attempt to deliver all queued messages.')) {
        fetch('/mail/postfix/flush-queue', { method: 'POST' })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('Mail queue flushed successfully');
              setTimeout(refreshQueueInfo, 2000);
            } else {
              alert('Failed to flush queue: ' + data.message);
            }
          })
          .catch(error => alert('Error: ' + error.message));
      }
    }

    function deleteQueue() {
      if (confirm('Are you sure you want to delete all messages in the queue? This action cannot be undone.')) {
        // TODO: Implement queue deletion
        alert('Queue deletion will be implemented in the next update');
      }
    }

    function showQueueDetails() {
      fetch('/mail/postfix/queue')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // TODO: Implement queue details view
            alert('Queue details view will be implemented in the next update');
          } else {
            alert('Failed to load queue details: ' + data.message);
          }
        })
        .catch(error => alert('Error: ' + error.message));
    }

    // Domain management
    function loadDomains() {
      // TODO: Implement domain loading from backend
      const domainsTable = document.getElementById('domains-table');
      domainsTable.innerHTML = `
        <tr>
          <td colspan="4" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">Domain loading will be implemented in the next update</td>
        </tr>
      `;
    }

    function showAddDomainModal() {
      document.getElementById('addDomainModal').classList.remove('hidden');
    }

    function closeAddDomainModal() {
      document.getElementById('addDomainModal').classList.add('hidden');
      document.getElementById('addDomainForm').reset();
    }

    // Form submission
    document.getElementById('addDomainForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const domain = document.getElementById('domain').value.trim();
      
      if (!domain) {
        alert('Please enter a domain name');
        return;
      }

      fetch('/mail/postfix/add-domain', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ domain: domain })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Domain added successfully');
          closeAddDomainModal();
          loadDomains();
        } else {
          alert('Failed to add domain: ' + data.message);
        }
      })
      .catch(error => alert('Error: ' + error.message));
    });

    // Configuration file viewing
    function viewConfigFile(filename) {
      // TODO: Implement config file viewing
      alert(`Configuration file viewing for ${filename} will be implemented in the next update`);
    }

    function closeConfigModal() {
      document.getElementById('configModal').classList.add('hidden');
    }

    // Placeholder functions
    function showPostfixLogs() {
      alert('Postfix log viewing will be implemented in the next update');
    }
  </script>
{% endblock %}
