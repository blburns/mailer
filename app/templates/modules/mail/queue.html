{% extends 'base.html' %}
{% block title %}Mail Queue Management{% endblock %}
{% block content %}
  <div class="max-w-screen-xl mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
      <div>
        <h1 class="text-3xl font-extrabold text-gray-900 dark:text-white">
          Mail Queue Management
        </h1>
        <p class="text-gray-600 dark:text-gray-400 mt-2">
          Monitor and manage the Postfix mail queue
        </p>
      </div>
      <div class="flex space-x-3">
        <a href="{{ url_for('mail.index') }}" class="inline-flex items-center px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium rounded-lg transition-colors duration-200">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
          Back to Mail
        </a>
        <button onclick="refreshQueueInfo()" class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors duration-200">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          Refresh
        </button>
      </div>
    </div>

    <!-- Queue Overview -->
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 mb-8">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Queue Overview</h3>
        <span id="queue-status-badge" class="px-3 py-1 text-sm font-medium rounded-full bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200">
          Loading...
        </span>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
        <div class="text-center p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
          <div class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="incoming-count">-</div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Incoming</div>
          <div class="text-xs text-gray-500 dark:text-gray-500" id="incoming-size">-</div>
        </div>
        <div class="text-center p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
          <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="active-count">-</div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Active</div>
          <div class="text-xs text-gray-500 dark:text-gray-500" id="active-size">-</div>
        </div>
        <div class="text-center p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
          <div class="text-2xl font-bold text-yellow-600 dark:text-yellow-400" id="deferred-count">-</div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Deferred</div>
          <div class="text-xs text-gray-500 dark:text-gray-500" id="deferred-size">-</div>
        </div>
        <div class="text-center p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
          <div class="text-2xl font-bold text-red-600 dark:text-red-400" id="hold-count">-</div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Hold</div>
          <div class="text-xs text-gray-500 dark:text-gray-500" id="hold-size">-</div>
        </div>
      </div>
      
      <div class="flex flex-wrap gap-3">
        <button onclick="flushAllQueues()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors duration-200">
          Flush All Queues
        </button>
        <button onclick="flushDeferredQueue()" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white text-sm font-medium rounded-lg transition-colors duration-200">
          Flush Deferred
        </button>
        <button onclick="flushHoldQueue()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-lg transition-colors duration-200">
          Flush Hold
        </button>
        <button onclick="deleteAllQueues()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium rounded-lg transition-colors duration-200">
          Delete All
        </button>
      </div>
    </div>

    <!-- Queue Operations -->
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 mb-8">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Queue Operations</h3>
        <div class="flex space-x-2">
          <button onclick="showQueueFilters()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium rounded-lg transition-colors duration-200">
            Filters
          </button>
          <button onclick="exportQueueData()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium rounded-lg transition-colors duration-200">
            Export
          </button>
        </div>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
          <h4 class="font-semibold text-gray-900 dark:text-white mb-2">Message Actions</h4>
          <div class="space-y-2">
            <button onclick="deleteSelectedMessages()" class="w-full px-3 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-lg transition-colors duration-200">
              Delete Selected
            </button>
            <button onclick="holdSelectedMessages()" class="w-full px-3 py-2 bg-yellow-600 hover:bg-yellow-700 text-white text-sm font-medium rounded-lg transition-colors duration-200">
              Hold Selected
            </button>
            <button onclick="releaseSelectedMessages()" class="w-full px-3 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors duration-200">
              Release Selected
            </button>
          </div>
        </div>
        
        <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
          <h4 class="font-semibold text-gray-900 dark:text-white mb-2">Queue Maintenance</h4>
          <div class="space-y-2">
            <button onclick="cleanupExpiredMessages()" class="w-full px-3 py-2 bg-orange-600 hover:bg-orange-700 text-white text-sm font-medium rounded-lg transition-colors duration-200">
              Cleanup Expired
            </button>
            <button onclick="rebuildQueueIndex()" class="w-full px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors duration-200">
              Rebuild Index
            </button>
            <button onclick="checkQueueIntegrity()" class="w-full px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium rounded-lg transition-colors duration-200">
              Check Integrity
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Queue Details Table -->
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 mb-8">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Queue Details</h3>
        <div class="flex items-center space-x-4">
          <div class="flex items-center space-x-2">
            <label class="text-sm text-gray-600 dark:text-gray-400">Queue:</label>
            <select id="queue-filter" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="all">All Queues</option>
              <option value="incoming">Incoming</option>
              <option value="active">Active</option>
              <option value="deferred">Deferred</option>
              <option value="hold">Hold</option>
            </select>
          </div>
          <div class="flex items-center space-x-2">
            <label class="text-sm text-gray-600 dark:text-gray-400">Limit:</label>
            <select id="message-limit" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="50">50</option>
              <option value="100" selected>100</option>
              <option value="200">200</option>
              <option value="500">500</option>
            </select>
          </div>
        </div>
      </div>
      
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
          <thead class="bg-gray-50 dark:bg-gray-700">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                <input type="checkbox" id="select-all" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Message ID</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">From</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">To</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Size</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Queue</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Age</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody id="queue-messages-tbody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
            <tr>
              <td colspan="8" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">
                Loading queue information...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div class="mt-4 flex items-center justify-between">
        <div class="text-sm text-gray-700 dark:text-gray-300">
          Showing <span id="showing-count">0</span> of <span id="total-count">0</span> messages
        </div>
        <div class="flex space-x-2">
          <button id="prev-page" onclick="previousPage()" class="px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium rounded-lg transition-colors duration-200 disabled:opacity-50" disabled>
            Previous
          </button>
          <span class="px-3 py-2 text-sm text-gray-700 dark:text-gray-300">
            Page <span id="current-page">1</span> of <span id="total-pages">1</span>
          </span>
          <button id="next-page" onclick="nextPage()" class="px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium rounded-lg transition-colors duration-200 disabled:opacity-50" disabled>
            Next
          </button>
        </div>
      </div>
    </div>

    <!-- Performance Metrics -->
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 mb-8">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Performance Metrics</h3>
        <button onclick="refreshMetrics()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors duration-200">
          Refresh Metrics
        </button>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
          <h4 class="font-semibold text-gray-900 dark:text-white mb-2">Processing Rate</h4>
          <div class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="processing-rate">-</div>
          <div class="text-sm text-gray-600 dark:text-gray-400">messages/minute</div>
        </div>
        
        <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
          <h4 class="font-semibold text-gray-900 dark:text-white mb-2">Average Wait Time</h4>
          <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="avg-wait-time">-</div>
          <div class="text-sm text-gray-600 dark:text-gray-400">minutes</div>
        </div>
        
        <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
          <h4 class="font-semibold text-gray-900 dark:text-white mb-2">Queue Health</h4>
          <div class="text-2xl font-bold text-purple-600 dark:text-purple-400" id="queue-health">-</div>
          <div class="text-sm text-gray-600 dark:text-gray-400">score</div>
        </div>
      </div>
    </div>

    <!-- Filters Modal -->
    <div id="filters-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
      <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white dark:bg-gray-800">
        <div class="mt-3">
          <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Queue Filters</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Sender Domain</label>
              <input type="text" id="sender-domain-filter" placeholder="example.com" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Recipient Domain</label>
              <input type="text" id="recipient-domain-filter" placeholder="example.com" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Message Size Range</label>
              <div class="flex space-x-2">
                <input type="number" id="min-size-filter" placeholder="Min (KB)" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <span class="text-gray-500 dark:text-gray-400 self-center">to</span>
                <input type="number" id="max-size-filter" placeholder="Max (KB)" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Age Range (hours)</label>
              <div class="flex space-x-2">
                <input type="number" id="min-age-filter" placeholder="Min" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <span class="text-gray-500 dark:text-gray-400 self-center">to</span>
                <input type="number" id="max-age-filter" placeholder="Max" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
            </div>
          </div>
          <div class="flex justify-end space-x-3 mt-6">
            <button onclick="hideQueueFilters()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium rounded-lg">
              Cancel
            </button>
            <button onclick="applyFilters()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg">
              Apply Filters
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentPage = 1;
    let totalPages = 1;
    let selectedMessages = new Set();
    let queueData = {};

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      refreshQueueInfo();
      setupEventListeners();
    });

    function setupEventListeners() {
      document.getElementById('select-all').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('input[name="message-select"]');
        checkboxes.forEach(checkbox => {
          checkbox.checked = this.checked;
          if (this.checked) {
            selectedMessages.add(checkbox.value);
          } else {
            selectedMessages.delete(checkbox.value);
          }
        });
      });

      document.getElementById('queue-filter').addEventListener('change', function() {
        currentPage = 1;
        refreshQueueInfo();
      });

      document.getElementById('message-limit').addEventListener('change', function() {
        currentPage = 1;
        refreshQueueInfo();
      });
    }

    function refreshQueueInfo() {
      const queue = document.getElementById('queue-filter').value;
      const limit = document.getElementById('message-limit').value;
      
      fetch(`/mail/postfix/queue?queue=${queue}&limit=${limit}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            updateQueueDisplay(data.queue);
          } else {
            showError('Failed to get queue information: ' + data.message);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showError('Failed to get queue information');
        });
    }

    function updateQueueDisplay(queueData) {
      // Update overview counts
      document.getElementById('incoming-count').textContent = queueData.incoming?.count || '0';
      document.getElementById('incoming-size').textContent = formatBytes(queueData.incoming?.size || 0);
      document.getElementById('active-count').textContent = queueData.active?.count || '0';
      document.getElementById('active-size').textContent = formatBytes(queueData.active?.size || 0);
      document.getElementById('deferred-count').textContent = queueData.deferred?.count || '0';
      document.getElementById('deferred-size').textContent = formatBytes(queueData.deferred?.size || 0);
      document.getElementById('hold-count').textContent = queueData.hold?.count || '0';
      document.getElementById('hold-size').textContent = formatBytes(queueData.hold?.size || 0);

      // Update status badge
      const totalMessages = (queueData.incoming?.count || 0) + (queueData.active?.count || 0) + 
                           (queueData.deferred?.count || 0) + (queueData.hold?.count || 0);
      
      const statusBadge = document.getElementById('queue-status-badge');
      if (totalMessages === 0) {
        statusBadge.className = 'px-3 py-1 text-sm font-medium rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
        statusBadge.textContent = 'Empty';
      } else if (totalMessages < 100) {
        statusBadge.className = 'px-3 py-1 text-sm font-medium rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';
        statusBadge.textContent = 'Normal';
      } else if (totalMessages < 1000) {
        statusBadge.className = 'px-3 py-1 text-sm font-medium rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
        statusBadge.textContent = 'High';
      } else {
        statusBadge.className = 'px-3 py-1 text-sm font-medium rounded-full bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
        statusBadge.textContent = 'Critical';
      }

      // Update messages table
      updateMessagesTable(queueData.messages || []);
      
      // Update pagination
      updatePagination(queueData.messages?.length || 0);
    }

    function updateMessagesTable(messages) {
      const tbody = document.getElementById('queue-messages-tbody');
      tbody.innerHTML = '';

      if (messages.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">
              No messages in queue
            </td>
          </tr>
        `;
        return;
      }

      messages.forEach(message => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700';
        
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <input type="checkbox" name="message-select" value="${message.id}" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">${message.id}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${message.from}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${message.to}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${formatBytes(message.size)}</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getQueueBadgeClass(message.queue)}">
              ${message.queue}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${formatAge(message.arrival_time)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
            <button onclick="deleteMessage('${message.id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">Delete</button>
          </td>
        `;
        
        tbody.appendChild(row);
      });

      // Re-setup message selection
      setupMessageSelection();
    }

    function setupMessageSelection() {
      const checkboxes = document.querySelectorAll('input[name="message-select"]');
      checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          if (this.checked) {
            selectedMessages.add(this.value);
          } else {
            selectedMessages.delete(this.value);
          }
          updateSelectAllCheckbox();
        });
      });
    }

    function updateSelectAllCheckbox() {
      const selectAll = document.getElementById('select-all');
      const checkboxes = document.querySelectorAll('input[name="message-select"]');
      const checkedCount = document.querySelectorAll('input[name="message-select"]:checked').length;
      
      if (checkedCount === 0) {
        selectAll.indeterminate = false;
        selectAll.checked = false;
      } else if (checkedCount === checkboxes.length) {
        selectAll.indeterminate = false;
        selectAll.checked = true;
      } else {
        selectAll.indeterminate = true;
        selectAll.checked = false;
      }
    }

    function updatePagination(messageCount) {
      const limit = parseInt(document.getElementById('message-limit').value);
      totalPages = Math.ceil(messageCount / limit);
      
      document.getElementById('showing-count').textContent = messageCount;
      document.getElementById('total-count').textContent = messageCount;
      document.getElementById('current-page').textContent = currentPage;
      document.getElementById('total-pages').textContent = totalPages;
      
      document.getElementById('prev-page').disabled = currentPage <= 1;
      document.getElementById('next-page').disabled = currentPage >= totalPages;
    }

    function previousPage() {
      if (currentPage > 1) {
        currentPage--;
        refreshQueueInfo();
      }
    }

    function nextPage() {
      if (currentPage < totalPages) {
        currentPage++;
        refreshQueueInfo();
      }
    }

    function flushAllQueues() {
      if (confirm('Are you sure you want to flush all queues? This will attempt to deliver all pending messages.')) {
        fetch('/mail/postfix/flush-queue', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showSuccess('All queues flushed successfully');
            setTimeout(refreshQueueInfo, 2000);
          } else {
            showError('Failed to flush queues: ' + data.message);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showError('Failed to flush queues');
        });
      }
    }

    function flushDeferredQueue() {
      if (confirm('Are you sure you want to flush the deferred queue?')) {
        // Implementation for flushing deferred queue
        showInfo('Flushing deferred queue...');
      }
    }

    function flushHoldQueue() {
      if (confirm('Are you sure you want to flush the hold queue?')) {
        // Implementation for flushing hold queue
        showInfo('Flushing hold queue...');
      }
    }

    function deleteAllQueues() {
      if (confirm('Are you sure you want to delete ALL messages from ALL queues? This action cannot be undone!')) {
        // Implementation for deleting all messages
        showInfo('Deleting all messages...');
      }
    }

    function deleteSelectedMessages() {
      if (selectedMessages.size === 0) {
        showError('No messages selected');
        return;
      }
      
      if (confirm(`Are you sure you want to delete ${selectedMessages.size} selected messages?`)) {
        // Implementation for deleting selected messages
        showInfo(`Deleting ${selectedMessages.size} messages...`);
        selectedMessages.clear();
        updateSelectAllCheckbox();
      }
    }

    function holdSelectedMessages() {
      if (selectedMessages.size === 0) {
        showError('No messages selected');
        return;
      }
      
      // Implementation for holding selected messages
      showInfo(`Holding ${selectedMessages.size} messages...`);
    }

    function releaseSelectedMessages() {
      if (selectedMessages.size === 0) {
        showError('No messages selected');
        return;
      }
      
      // Implementation for releasing selected messages
      showInfo(`Releasing ${selectedMessages.size} messages...`);
    }

    function deleteMessage(messageId) {
      if (confirm('Are you sure you want to delete this message?')) {
        // Implementation for deleting single message
        showInfo('Deleting message...');
      }
    }

    function cleanupExpiredMessages() {
      if (confirm('Clean up expired messages from the queue?')) {
        // Implementation for cleanup
        showInfo('Cleaning up expired messages...');
      }
    }

    function rebuildQueueIndex() {
      if (confirm('Rebuild the queue index? This may take a few minutes.')) {
        // Implementation for rebuilding index
        showInfo('Rebuilding queue index...');
      }
    }

    function checkQueueIntegrity() {
      // Implementation for integrity check
      showInfo('Checking queue integrity...');
    }

    function showQueueFilters() {
      document.getElementById('filters-modal').classList.remove('hidden');
    }

    function hideQueueFilters() {
      document.getElementById('filters-modal').classList.add('hidden');
    }

    function applyFilters() {
      // Implementation for applying filters
      hideQueueFilters();
      showInfo('Filters applied');
      refreshQueueInfo();
    }

    function exportQueueData() {
      // Implementation for exporting queue data
      showInfo('Exporting queue data...');
    }

    function refreshMetrics() {
      // Implementation for refreshing metrics
      showInfo('Refreshing metrics...');
    }

    // Utility functions
    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function formatAge(timestamp) {
      if (!timestamp) return '-';
      const age = Math.floor((Date.now() - new Date(timestamp)) / (1000 * 60 * 60));
      if (age < 1) return '< 1h';
      if (age < 24) return `${age}h`;
      return `${Math.floor(age / 24)}d`;
    }

    function getQueueBadgeClass(queue) {
      switch (queue) {
        case 'incoming': return 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';
        case 'active': return 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
        case 'deferred': return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
        case 'hold': return 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
        default: return 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200';
      }
    }

    function showSuccess(message) {
      // Implementation for success notifications
      alert('Success: ' + message);
    }

    function showError(message) {
      // Implementation for error notifications
      alert('Error: ' + message);
    }

    function showInfo(message) {
      // Implementation for info notifications
      alert('Info: ' + message);
    }
  </script>
{% endblock %}
