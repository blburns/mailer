# Apache reverse proxy vhost for DreamlikeLabs (Waitress backend)
# Requires: a2enmod proxy proxy_http headers remoteip

APP_NAME=mailer

<VirtualHost *:80>
    ServerName mailer.dreamlikelabs.com
    ServerAlias www.mailer.dreamlikelabs.com

    # Preserve original Host header for app routing
    ProxyPreserveHost On

    # Forward client details to the app (Flask ProxyFix consumes these)
    RequestHeader set X-Forwarded-Proto expr=%{REQUEST_SCHEME}
    RequestHeader set X-Forwarded-Host "expr=%{HTTP_HOST}"
    RemoteIPHeader X-Forwarded-For
    RemoteIPTrustedProxy 127.0.0.1

    # Reverse proxy to local Waitress
    ProxyPass        / http://127.0.0.1:5025/
    ProxyPassReverse / http://127.0.0.1:5025/

    # Optionally serve static assets directly from disk (adjust path as deployed)
    # Alias /static /opt/dreamlikelabs/${APP_NAME}/app/static
    # <Directory /opt/dreamlikelabs/${APP_NAME}/app/static>
    #     Require all granted
    # </Directory>

    # Logs
    ErrorLog ${APACHE_LOG_DIR}/dreamlikelabs/${APP_NAME}/proxy-error.log
    CustomLog ${APACHE_LOG_DIR}/dreamlikelabs/${APP_NAME}/proxy-access.log combined
</VirtualHost>

# Optional HTTPS vhost (enable with valid certs)
# <IfModule mod_ssl.c>
# <VirtualHost *:443>
#     ServerName example.com
#     ServerAlias www.example.com
#
#     SSLEngine on
#     SSLCertificateFile    /etc/ssl/certs/example.crt
#     SSLCertificateKeyFile /etc/ssl/private/example.key
#     # SSLCertificateChainFile /etc/ssl/certs/chain.crt
#
#     ProxyPreserveHost On
#     RequestHeader set X-Forwarded-Proto "https"
#     RequestHeader set X-Forwarded-Host "expr=%{HTTP_HOST}"
#     RemoteIPHeader X-Forwarded-For
#     RemoteIPTrustedProxy 127.0.0.1
#
#     ProxyPass        / http://127.0.0.1:5050/
#     ProxyPassReverse / http://127.0.0.1:5050/
#
#     # Alias /static /opt/dreamlikelabs/app/static
#     # <Directory /opt/dreamlikelabs/app/static>
#     #     Require all granted
#     # </Directory>
#
#     ErrorLog ${APACHE_LOG_DIR}/dreamlikelabs_proxy_ssl_error.log
#     CustomLog ${APACHE_LOG_DIR}/dreamlikelabs_proxy_ssl_access.log combined
# </VirtualHost>
# </IfModule>


