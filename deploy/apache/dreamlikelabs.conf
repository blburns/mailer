# Apache mod_wsgi vhost for DreamlikeLabs Flask app
# Prereqs: apt-get install libapache2-mod-wsgi-py3

APP_NAME=mailer

WSGIDaemonProcess dreamlikelabs-${APP_NAME} \
  user=www-data group=www-data \
  processes=2 threads=4 \
  display-name=%{GROUP} \
  python-home=/opt/dreamlikelabs/${APP_NAME}/venv \
  python-path=/opt/dreamlikelabs/${APP_NAME}

WSGIScriptAlias / /opt/dreamlikelabs/${APP_NAME}/deploy/apache/dreamlikelabs.wsgi process-group=dreamlikelabs-${APP_NAME} application-group=%{GLOBAL}

<VirtualHost *:80>
    ServerName dreamlikelabs.com
    ServerAlias www.dreamlikelabs.com

    # Serve the Flask app via mod_wsgi
    <Directory /opt/dreamlikelabs/${APP_NAME}>
        Require all granted
    </Directory>

    # Static files (adjust path if needed)
    Alias /static /opt/dreamlikelabs/${APP_NAME}/app/static
    <Directory /opt/dreamlikelabs/${APP_NAME}/app/static>
        Require all granted
        ExpiresActive On
        ExpiresDefault "access plus 1d"
    </Directory>

    ErrorLog /srv/www/dreamlikelabs/logs/${APP_NAME}/dreamlikelabs-error.log
    CustomLog /srv/www/dreamlikelabs/logs/${APP_NAME}/dreamlikelabs-access.log combined
</VirtualHost>

# Optional HTTPS vhost (requires valid certs)
<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName ${APP_NAME}.dreamlikelabs.com
    ServerAlias www.${APP_NAME}.dreamlikelabs.com


    SSLEngine On
    SSLCertificateFile      /etc/letsencrypt/live/example.com/fullchain.pem
    SSLCertificateKeyFile   /etc/letsencrypt/live/example.com/privkey.pem

    <Directory /opt/dreamlikelabs/${APP_NAME}>
        Require all granted
    </Directory>

    Alias /static /opt/dreamlikelabs/${APP_NAME}/app/static
    <Directory /opt/dreamlikelabs/${APP_NAME}/app/static>
        Require all granted
        ExpiresActive On
        ExpiresDefault "access plus 1d"
    </Directory>

    WSGIDaemonProcess dreamlikelabs-ssl \
      user=www-data group=www-data \
      processes=2 threads=4 \
      display-name=%{GROUP} \
      python-home=/opt/dreamlikelabs/${APP_NAME}/venv \
      python-path=/opt/dreamlikelabs/${APP_NAME}

    WSGIScriptAlias / /opt/dreamlikelabs/${APP_NAME}/deploy/apache/dreamlikelabs.wsgi process-group=dreamlikelabs-ssl application-group=%{GLOBAL}

    ErrorLog /srv/www/dreamlikelabs/logs/${APP_NAME}/dreamlikelabs-error.log
    CustomLog /srv/www/dreamlikelabs/logs/${APP_NAME}/dreamlikelabs-access.log combined
</VirtualHost>
</IfModule>


